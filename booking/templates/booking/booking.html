{% extends "./base.html" %}

{% block title %}Book Your Appointment{% endblock %}

{% block body %}

<div class="booking-container">

    <h1 id="h1-head">Select a Date</h1>

    <!-- Calender widget -->
    <div id='calendar' service-id="{{ service_id }}"></div>

    <!-- Available Time Slots -->
    <h3>Ledige tidspunkter:</h3>
    <div id="available-slots" class="slots-container"></div>

    <!-- Confirm booking -->
    <button id="confirm-booking" style="display: none;">Confirm Booking</button>
</div>
{{ trainer|json_script:"trainer-name"}}
{% endblock %}



{% block customJS %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
<script></script>
<script>

document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    var serviceId = calendarEl.getAttribute('service-id');  // Get booking ID

    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        selectable: true,
        dateClick: function(info) {

            // fetchAvailableTimes(info.dateStr, serviceId);
            const selectedDate = new Date(info.dateStr);

            // sjekk om valgt dato er passert
            const today = new Date();
            today.setHours(0,0,0,0);
            if(selectedDate < today) {
              console.log("Date is in the past");
            } else {
              
              // call fetchAvailableTimes() here ...
              fetchAvailableTimeSlots(info.dateStr);

            }
        },
        selectAllow: function (info) {
        return (info.start >= getDateWithoutTime(new Date()));
    },
    });
    calendar.render();
});

function getDateWithoutTime(dt) {
    dt.setHours(0, 0, 0, 0);
    return dt;
}

  // Fetch available time slots when user selects a date
  function fetchAvailableTimeSlots(date) {
    fetch(`/booking/api/get_available_slots/?date=${date}`)
      .then(response => response.json())
      .then(data => {
        let slotsContainer = document.getElementById("available-slots");
        slotsContainer.innerHTML = ""; // Clear previous slots
        
        if (data.times.length > 0) {
          data.times.forEach(slot => {
            let btn = document.createElement("button");
            btn.classList.add("time-slot");
            btn.innerText = slot;
            btn.onclick = () => bookTimeSlot(date, slot);
            slotsContainer.appendChild(btn);
          });
        } else {
          slotsContainer.innerHTML = "<p>Ingen ledige tidspunkter.</p>";
        }
      });
  }


</script>
{% endblock %}


